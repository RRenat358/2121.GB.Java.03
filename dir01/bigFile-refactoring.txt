Рефа́кторинг (англ. refactoring), или перепроектирование кода, переработка кода, равносильное преобразование алгоритмов — процесс изменения внутренней структуры программы, не затрагивающий её внешнего поведения и имеющий целью облегчить понимание её работы[1][2]. В основе рефакторинга лежит последовательность небольших эквивалентных (то есть сохраняющих поведение) преобразований. Поскольку каждое преобразование маленькое, программисту легче проследить за его правильностью, и в то же время вся последовательность может привести к существенной перестройке программы и улучшению её согласованности и чёткости.


Содержание
1	Цели рефакторинга
2	Причины применения рефакторинга
3	Признаки плохого кода
4	Рефакторинг кода
5	Методы рефакторинга
5.1	Изменение сигнатуры метода (change method signature)
5.2	Инкапсуляция поля (encapsulate field)
5.3	Выделение метода (extract method)
5.4	Перемещение метода (move method)
5.5	Замена условного оператора полиморфизмом (replace conditional with polymorphism)
6	Проблемы, возникающие при проведении рефакторинга
7	Средства автоматизации рефакторинга
8	См. также
9	Примечания
10	Литература
11	Ссылки


Цели рефакторинга

Цель рефакторинга — сделать код программы более легким для понимания; без этого рефакторинг нельзя считать успешным.

Рефакторинг следует отличать от оптимизации производительности. Как и рефакторинг, оптимизация обычно тоже не изменяет поведение программы, а только ускоряет её работу. Но оптимизация часто затрудняет понимание кода, что противоположно рефакторингу[3].

С другой стороны, нужно отличать рефакторинг и от реинжиниринга, который осуществляется для расширения функциональности программного обеспечения. Как правило, крупные рефакторинги предваряют реинжиниринг.

Причины применения рефакторинга
Рефакторинг нужно применять постоянно при разработке кода. Основными стимулами его проведения являются следующие задачи:

необходимо добавить новую функцию, которая недостаточно укладывается в принятое архитектурное решение;
необходимо исправить ошибку, причины возникновения которой сразу не ясны;
преодоление трудностей в командной разработке, которые обусловлены сложной логикой программы.
Признаки плохого кода
Основная статья: Код с запашком
Во многом при рефакторинге лучше полагаться на интуицию, основанную на опыте. Тем не менее имеются некоторые видимые проблемы в коде (англ. code smells), требующие рефакторинга:

дублирование кода;
длинный метод;
большой класс;
длинный список параметров;
«жадные» функции — это метод, который чрезмерно обращается к данным другого объекта;
избыточные временные переменные;
классы данных;
несгруппированные данные.
Рефакторинг кода
В программировании термин рефакторинг означает изменение исходного кода программы без изменения его внешнего поведения. В экстремальном программировании и других гибких методологиях рефакторинг является неотъемлемой частью цикла разработки ПО: разработчики попеременно то создают новые тесты и функциональность, то выполняют рефакторинг кода для улучшения его логичности и прозрачности. Автоматическое юнит-тестирование позволяет убедиться, что рефакторинг не разрушил существующую функциональность.

Рефакторинг изначально не предназначен для исправления ошибок и добавления новой функциональности, он вообще не меняет поведение программного обеспечения[3] и это помогает избежать ошибок и облегчить добавление функциональности. Он выполняется для улучшения понятности кода или изменения его структуры, для удаления «мёртвого кода» — всё это для того, чтобы в будущем код было легче поддерживать и развивать. В частности, добавление в программу нового поведения может оказаться сложным с существующей структурой — в этом случае разработчик может выполнить необходимый рефакторинг, а уже затем добавить новую функциональность.

Это может быть перемещение поля из одного класса в другой, вынесение фрагмента кода из метода и превращение его в самостоятельный метод или даже перемещение кода по иерархии классов. Каждый отдельный шаг может показаться элементарным, но совокупный эффект таких малых изменений в состоянии радикально улучшить проект или даже предотвратить распад плохо спроектированной программы.

Методы рефакторинга
Наиболее употребимые[4] методы рефакторинга:

Изменение сигнатуры метода (change method signature)
Инкапсуляция поля (encapsulate field)
Выделение класса (extract class)
Выделение интерфейса (extract interface)
Выделение локальной переменной (extract local variable)
Выделение метода (extract method)
Генерализация типа (generalize type)
Встраивание (inline)
Введение фабрики (introduce factory)
Введение параметра (introduce parameter)
Подъём метода (pull up method)
Спуск метода (push down method)
Переименование метода (rename method)
Перемещение метода (move method)
Замена условного оператора полиморфизмом (replace conditional with polymorphism)
Замена наследования делегированием (replace inheritance with delegation)
Замена кода типа подклассами (replace type code with subclasses)
Изменение сигнатуры метода (change method signature)
Суть изменения сигнатуры метода заключается в добавлении, изменении или удалении параметра метода. Изменив сигнатуру метода, необходимо скорректировать обращения к нему в коде всех клиентов. Это изменение может затронуть внешний интерфейс программы, кроме того, не всегда разработчику, изменяющему интерфейс, доступны все клиенты этого интерфейса, поэтому может потребоваться та или иная форма регистрации изменений интерфейса для последующей передачи их вместе с новой версией программы.

Инкапсуляция поля (encapsulate field)
В случае, если у класса имеется открытое поле, необходимо сделать его закрытым и обеспечить методы доступа. После «Инкапсуляции поля» часто применяется «Перемещение метода».

Выделение метода (extract method)
Выделение метода заключается в выделении из длинного и/или требующего комментариев кода отдельных фрагментов и преобразовании их в отдельные методы, с подстановкой подходящих вызовов в местах использования. В этом случае действует правило: если фрагмент кода требует комментария о том, что он делает, то он должен быть выделен в отдельный метод. Также правило: один метод не должен занимать более чем один экран (25-50 строк, в зависимости от условий редактирования), в противном случае некоторые его фрагменты имеют самостоятельную ценность и подлежат выделению. Из анализа связей выделяемого фрагмента с окружающим контекстом делается вывод о перечне параметров нового метода и его локальных переменных.

Перемещение метода (move method)
Перемещение метода применяется по отношению к методу, который чаще обращается к другому классу, чем к тому, в котором сам располагается.

Замена условного оператора полиморфизмом (replace conditional with polymorphism)
Условный оператор с несколькими ветвями заменяется вызовом полиморфного метода некоторого базового класса, имеющего подклассы для каждой ветви исходного оператора. Выбор ветви осуществляется неявно, в зависимости от того, экземпляру какого из подклассов оказался адресован вызов.

Основные принципы:

вначале следует создать базовый класс и нужное число подклассов;
в некоторых случаях следует провести оптимизацию условного оператора путём «Выделения метода»;
возможно использование «Перемещения метода», чтобы поместить условный оператор в вершину иерархии наследования;
выбрав один из подклассов, нужно конкретизировать в нём полиморфный метод базового класса и переместить в него тело соответствующей ветви условного оператора;
повторить предыдущее действие для каждой ветви условного оператора;
заменить весь условный оператор вызовом полиморфного метода базового класса.
Проблемы, возникающие при проведении рефакторинга
проблемы, связанные с базами данных;
проблемы изменения интерфейсов;
трудности при изменении дизайна.
Средства автоматизации рефакторинга
Технические критерии для инструментов рефакторинга:

базы данных программы;
деревья синтаксического разбора;
точность.
Практические критерии для инструментов рефакторинга:

скорость;
отмена модификаций;
интеграция с другими инструментами.